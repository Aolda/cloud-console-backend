stages: [check, build, test, package]

# 0) 러너 연결 스모크 테스트
check_runner:
  stage: check
  # 프로젝트 러너에 태그가 acc 라면 유지, Run untagged jobs를 켰다면 이 줄 삭제해도 됨
  tags: [acc]
  script:
    - echo "runner OK"
    - java -version || true

# 1) Gradle 빌드 (테스트 제외)
build:
  stage: build
  tags: [acc]
  image: eclipse-temurin:21-jdk
  cache:
    key: "${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon clean build -x test
  artifacts:
    when: always
    paths:
      - build/libs/
    expire_in: 7 days
  rules:
    - exists:
        - gradlew
        - build.gradle
        - settings.gradle*

# 2) Gradle 테스트(+커버리지 있으면 자동 수집)
test:
  stage: test
  tags: [acc]
  # allow_failure: true   # ← 실패해도 파이프라인은 계속 진행
  image: eclipse-temurin:21-jdk
  services:
    - name: mariadb:11
      alias: mariadb
  needs: ["build"]
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon test jacocoTestReport || ./gradlew --no-daemon test
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/test/*.xml
      coverage_report:
        coverage_format: jacoco
        path: build/reports/jacoco/test/jacocoTestReport.xml
    paths:
      - build/reports/tests/test
      - build/reports/jacoco/test
  coverage: '/TOTAL.*?([0-9]{1,3})%/'

# 3) 패키징(메인 브랜치일 때만)
package:
  stage: package
  tags: [acc]
  image: eclipse-temurin:21-jdk
  needs: ["test"]
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon assemble
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH

variables:
  SPRING_PROFILES_ACTIVE: test
