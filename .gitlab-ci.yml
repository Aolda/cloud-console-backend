image: eclipse-temurin:21-jdk

default:
  cache:
    key: "${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
    policy: pull-push
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - java -version

stages:
  - build
  - test
  - quality   # optional
  - security  # optional
  - package

build:
  stage: build
  rules:
    - exists:
        - gradlew
        - build.gradle
        - settings.gradle*
        - gradle.properties
  script:
    - chmod +x gradlew
    - ./gradlew --no-daemon clean build -x test
  artifacts:
    when: always
    paths:
      - build/libs/
    expire_in: 7 days
  tags: [docker, java]   # 러너에 태그가 필요하면 맞춰서 수정

test:
  stage: test
  needs: ["build"]
  script:
    - ./gradlew --no-daemon test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/test/*.xml
      coverage_report:
        coverage_format: jacoco
        path: build/reports/jacoco/test/jacocoTestReport.xml
    paths:
      - build/reports/tests/test
      - build/reports/jacoco/test
  coverage: '/TOTAL.*?([0-9]{1,3})%/'
  rules:
    - if: $CI_PIPELINE_SOURCE =~ /push|merge_request_event/

quality:
  stage: quality
  allow_failure: true
  script:
    # 프로젝트에 설정돼 있으면 자동 실행됨. 없으면 그냥 스킵돼도 무방
    - ./gradlew --no-daemon check || true
    - ./gradlew --no-daemon spotbugsMain || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

security:gitleaks:
  stage: security
  image: zricethezav/gitleaks:latest
  allow_failure: true
  script:
    - gitleaks detect --source . --no-banner --redact --report-format sarif --report-path gl-gitleaks.sarif || true
  artifacts:
    when: always
    paths:
      - gl-gitleaks.sarif
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

package:
  stage: package
  needs: ["test"]
  script:
    - ./gradlew --no-daemon assemble
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH
