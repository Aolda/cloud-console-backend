stages: [check, build, test, package]

check_runner:
  stage: check
  tags: [acc]
  script:
    - echo "runner OK"
    - java -version || true

build:
  stage: build
  tags: [acc]
  image: eclipse-temurin:21-jdk
  cache:
    key: "${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon clean build -x test
  artifacts:
    when: always
    paths:
      - build/libs/
    expire_in: 7 days

test:
  stage: test
  tags: [acc]
  image: eclipse-temurin:21-jdk
  variables:
    SPRING_PROFILES_ACTIVE: "test"
  cache:
    key: "${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon clean test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/test/*.xml
      coverage_report:
        coverage_format: jacoco
        path: build/reports/jacoco/test/jacocoTestReport.xml
    paths:
      - build/reports/tests/test
      - build/reports/jacoco/test
  coverage: '/TOTAL.*?([0-9]{1,3})%/'

package:
  stage: package
  tags: [acc]
  image: eclipse-temurin:21-jdk
  needs: ["test"]
  before_script:
    - export GRADLE_USER_HOME="$CI_PROJECT_DIR/.gradle"
    - chmod +x gradlew
  script:
    - ./gradlew --no-daemon assemble
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH
